@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}

@model List<ProjectsAndCustomers.Models.Entities.ProjectEntity> // Make a list of the model


<h1>Projects</h1>
@* Button for opening the model which adds a project *@
<button id="addProjectBtn" onclick="openModal()">Add Project</button>>
@* Buttons for fitlering depending on the start end enddate which signals if the project is complete or in progress *@
<button id="allProjectsBtn" onclick="filterProjects('all')">All Projects</button>
<button id="completedProjectsBtn" onclick="filterProjects('completed')">Completed Projects</button>
<button id="startedProjectsBtn" onclick="filterProjects('started')">Started Projects</button>

<table class="table">
    <thead>
        <tr>
            <th>Id</th>
            <th>Title</th>
            <th>Description</th>
            <th>Start Date</th>
            <th>End Date</th>
            <th>Budget</th>
            <th>Customer Name</th>
            <th></th>
        </tr>
    </thead>
    <tbody id="projectsTable">
        @foreach (var project in Model)
        {
            <tr data-end-date="@project.EndDate" data-start-date="@project.StartDate">
                <td>@project.Id</td>
                <td>@project.Title</td>
                <td>@project.Description</td>
                <td>@project.StartDate.ToString("yyyy-MM-dd")</td>
                <td>@project.EndDate.ToString("yyyy-MM-dd")</td>
                <td>@project.Budget</td>
                <td>@project.Customer.CustomerName</td>
                <td>
@*                     <button class="btn btn-primary" onclick="editProduct(@project.Id)" data-project-id="@project.Id">Edit</button> This works, remove this text
 *@                

                    <div class="dropdown">
                        <!-- Dropdown menu -->
                        @if (User.Identity.IsAuthenticated)
                        {
                            <!-- Three dots button without arrow -->
                            <button class="btn btn-secondary custom-dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                                ...
                            </button>
                            <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                <li>
                                    <button class="dropdown-item" onclick="editProject(@project.Id)" data-project-id="@project.Id">Edit</button>
                                </li>
                                <li>
                                    <button class="dropdown-item" onclick="deleteProject(@project.Id)" data-project-id="@project.Id">Delete</button>
                                </li>
                            </ul>
                        }
                    </div>

                </td>
            </tr>
        }
    </tbody>
</table>


@* <div id="modalContainer"></div> *@
<div id="modalWrapper">
    @* Inject form here *@
</div>

@* The reusable partial view that loads the modal, it sends the model to it, copilot helped me with the code for activating the modal. *@
@Html.Partial("_AddProjectModal", new ProjectsAndCustomers.Models.AddProjectViewModel())
@await Html.PartialAsync("_EditProjectModal", new ProjectsAndCustomers.Models.Entities.ProjectEntity())




@* Copilot helped me with ajax code for modals *@
<script>
    //Delete button
    function deleteProject(projectId) {
        console.log("Deleting project with ID:", projectId);

        fetch(`/Projects/Delete?id=${projectId}`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                console.log("Project deleted successfully.");
                location.reload(); // Reload the page to reflect changes
            } else {
                console.error("Failed to delete the project.");
            }
        })
        .catch(error => {
            console.error("Error:", error);
        });
    }



    // Code for opening the add project modal
    function openModal() {
        $('#addProjectModal').modal('show'); 
    }
        $(function() {
        $('.editModal').modal();
    });
    // Code for opening the edit modal
    function editProject(productId) {
        console.log("Product ID:", productId);
        $.ajax({
            url: '/Projects/Edit/' + productId, // sends id to cotnroller
            success: function(data) {
                $('#modalWrapper').html(data); // Injects the partial view
                $('#editProjectModal').modal('show'); // Activates the modal
            }
        });
    }
    // Code for sumbitting the edit modal
    $(document).on('submit', '#editProjectModal form', function(event) {
        event.preventDefault(); // Prevent default form submission
        let formData = $(this).serialize();

        $.ajax({
            type: 'POST',
            url: '/Projects/Edit',
            data: formData,
            success: function(response) {
                console.log('Edit successful!');
                $('#editProjectModal').modal('hide'); // Close the modal
                location.reload(); // Reload the page 
            },
            error: function(xhr, status, error) {
                console.error('Edit failed:', error);
            }
        });
    });
</script>



<script> // Function to get and check all rows, and compare it to todays date, and filter depending on the button. Copilot helped.
    function filterProjects(filter) {
        const today = new Date(); // Today's date
        const rows = document.querySelectorAll('#projectsTable tr'); // All table rows

        rows.forEach(row => {
            const endDateRaw = row.getAttribute('data-end-date'); // Get raw end date string
            const startDateRaw = row.getAttribute('data-start-date'); // Get raw start date string

            // Convert European format (DD/MM/YYYY HH:mm:ss) to ISO format (YYYY-MM-DDTHH:mm:ss), because the date in the model isn´t in the correct format to compare.
            const endDate = convertToISO(endDateRaw);
            const startDate = convertToISO(startDateRaw);

            // Ensure conversion worked before comparing dates
            if (endDate && startDate) {
                switch (filter) {
                    case 'all':
                        row.style.display = ''; // Show all rows
                        break;
                    case 'completed':
                        row.style.display = (endDate < today) ? '' : 'none'; // Show completed rows
                        break;
                    case 'started':
                        row.style.display = (endDate >= today) ? '' : 'none'; // Show started rows
                        break;
                    default:
                        row.style.display = ''; // Default to showing all rows
                }
            } else {
                console.error('Failed to parse date:', endDateRaw, startDateRaw);
                row.style.display = 'none'; // Hide rows with invalid date format
            }
        });
    }

    // Helper function to convert European date format to ISO format, used by the filter function.
    function convertToISO(dateString) {
        if (!dateString) return null;

        const parts = dateString.split(/[/ :]/); // Split the date by "/", " ", and ":"
        if (parts.length < 5) return null;

        const [day, month, year, hours, minutes, seconds] = parts;
        // Format as ISO (YYYY-MM-DDTHH:mm:ss), s o that it can be compared to todayss date.
        return new Date(`${year}-${month}-${day}T${hours}:${minutes}:${seconds}`);
    }
</script>


